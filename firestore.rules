rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ================================
    // ATTEMPTS COLLECTION
    // ================================
    match /attempts/{attemptId} {

      // CREATE: exactly once
      allow create: if
        !exists(/databases/$(database)/documents/attempts/$(attemptId))
        && request.resource.data.status == "IN_PROGRESS"
        && request.resource.data.startTime is timestamp
        && request.resource.data.submitTime == null
        && request.resource.data.score == null;

      // READ: allowed (no auth, resume support)
      allow read: if true;

      // UPDATE: only while IN_PROGRESS, no score writes
      allow update: if
        resource.data.status == "IN_PROGRESS"
        && request.resource.data.status in ["IN_PROGRESS", "SUBMITTED"]
        && request.resource.data.startTime == resource.data.startTime
        && resource.data.score == null
        && request.resource.data.score == null;

      // DELETE: never allowed
      allow delete: if false;
    }

    // ================================
    // QUESTIONS COLLECTION
    // ================================
    match /questions/{questionId} {
      allow read: if true;
      allow create, update, delete: if false;
    }

    // ================================
    // EVENTS COLLECTION (anti-cheat logs)
    // ================================
    match /events/{eventId} {
      allow create: if true;
      allow read, update, delete: if false;
    }

    // ================================
    // EVERYTHING ELSE
    // ================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
