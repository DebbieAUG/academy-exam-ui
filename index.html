<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Online Exam</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center">

<div id="startScreen" class="bg-white p-8 rounded shadow max-w-md w-full text-center">
  <h1 class="text-2xl font-bold mb-4">Online Assessment</h1>
  <p class="text-gray-600 mb-6">
    Once you start the exam, it will enter fullscreen mode and the timer will begin.
  </p>
  <button id="startBtn"
    class="w-full py-3 bg-blue-600 text-white rounded font-semibold">
    Start Exam
  </button>
</div>

<div id="examScreen"
  class="hidden bg-white w-full max-w-3xl p-6 rounded shadow">

  <div class="flex justify-between mb-4">
    <h2 class="font-bold text-lg">Assessment</h2>
    <div id="timer" class="font-mono font-bold text-red-600"></div>
  </div>

  <div id="questionBox"></div>

  <div class="flex justify-between mt-6">
    <button id="prevBtn" class="px-4 py-2 bg-gray-300 rounded">Prev</button>
    <button id="nextBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Next</button>
  </div>

  <button id="submitBtn"
    class="mt-6 w-full py-3 bg-green-600 text-white rounded hidden">
    Submit Exam
  </button>
</div>

<script>
/* ================= CONFIG ================= */
const EXAM_ID = "AI_MIDTERM_01";
const EXAM_DURATION_MIN = 30;
const SUBMIT_URL = "https://script.google.com/macros/s/AKfycbxUX09weHXOk2D6iijxzIAscvZEQLeOIO_2Hx-YAdq2vRa55YBI9X_PcHIsb1eYDqGMSA/exec";

/* ================= STATE ================= */
let examStarted = false;
let currentQ = 0;
let answers = {};
let tabSwitchCount = 0;
let fullscreenExitCount = 0;
let pageReloadCount = 0;
let copyPasteAttempts = 0;
let examStartTime;

/* ================= QUESTIONS ================= */
let questions = shuffle([
  {
    id: "q1",
    text: "Which model type is best for tabular data?",
    options: ["CNN", "RNN", "Random Forest", "GAN"],
    correct: "Random Forest"
  },
  {
    id: "q2",
    text: "What does overfitting indicate?",
    options: [
      "High bias",
      "High variance",
      "Low accuracy",
      "Low training score"
    ],
    correct: "High variance"
  },
  {
    id: "q3",
    text: "Which metric is best for imbalanced datasets?",
    options: ["Accuracy", "Precision", "Recall", "F1 Score"],
    correct: "F1 Score"
  }
]);

questions.forEach(q => q.options = shuffle(q.options));

/* ================= START EXAM ================= */
document.getElementById("startBtn").onclick = async () => {
  await document.documentElement.requestFullscreen?.();
  examStarted = true;
  examStartTime = new Date().toISOString();

  document.getElementById("startScreen").classList.add("hidden");
  document.getElementById("examScreen").classList.remove("hidden");

  startTimer();
  renderQuestion();
};

/* ================= UI ================= */
function renderQuestion() {
  const q = questions[currentQ];
  document.getElementById("questionBox").innerHTML = `
    <div class="mb-4 font-semibold">
      Q${currentQ + 1}. ${q.text}
    </div>
    ${q.options.map(opt => `
      <label class="block mb-2">
        <input type="radio" name="option" value="${opt}"
          ${answers[q.id] === opt ? "checked" : ""}>
        ${opt}
      </label>
    `).join("")}
  `;

  document.querySelectorAll("input[name='option']").forEach(el => {
    el.onchange = () => answers[q.id] = el.value;
  });

  document.getElementById("prevBtn").disabled = currentQ === 0;
  document.getElementById("nextBtn").innerText =
    currentQ === questions.length - 1 ? "Review" : "Next";

  document.getElementById("submitBtn").classList.toggle(
    "hidden",
    currentQ !== questions.length - 1
  );
}

/* ================= TIMER ================= */
let timerInterval;
function startTimer() {
  let remaining = EXAM_DURATION_MIN * 60;
  timerInterval = setInterval(() => {
    remaining--;
    document.getElementById("timer").innerText =
      `${Math.floor(remaining / 60)}:${String(remaining % 60).padStart(2,"0")}`;

    if (remaining <= 0) submitExam();
  }, 1000);
}

/* ================= ANTI-CHEAT ================= */
document.addEventListener("visibilitychange", () => {
  if (examStarted && document.hidden) tabSwitchCount++;
});

document.addEventListener("fullscreenchange", () => {
  if (examStarted && !document.fullscreenElement) fullscreenExitCount++;
});

document.addEventListener("copy", e => {
  if (!examStarted) return;
  e.preventDefault();
  copyPasteAttempts++;
});
document.addEventListener("paste", e => {
  if (!examStarted) return;
  e.preventDefault();
  copyPasteAttempts++;
});

window.addEventListener("beforeunload", () => {
  if (examStarted) pageReloadCount++;
});

/* ================= NAV ================= */
document.getElementById("prevBtn").onclick = () => {
  if (currentQ > 0) currentQ--, renderQuestion();
};
document.getElementById("nextBtn").onclick = () => {
  if (currentQ < questions.length - 1) currentQ++, renderQuestion();
};
document.getElementById("submitBtn").onclick = submitExam;

/* ================= SUBMIT ================= */
function submitExam() {
  clearInterval(timerInterval);

  const examEndTime = new Date().toISOString();
  const totalTimeSec =
    Math.floor((new Date(examEndTime) - new Date(examStartTime)) / 1000);

  let score = 0;
  questions.forEach(q => {
    if (answers[q.id] === q.correct) score++;
  });

  const payload = {
    exam_id: EXAM_ID,
    answers,
    score,
    max_score: questions.length,
    exam_start_time: examStartTime,
    exam_end_time: examEndTime,
    total_time_sec: totalTimeSec,
    avg_time_per_q: totalTimeSec / questions.length,
    tab_switch_count: tabSwitchCount,
    fullscreen_exit_count: fullscreenExitCount,
    page_reload_count: pageReloadCount,
    copy_paste_attempts: copyPasteAttempts,
    integrity_flag:
      tabSwitchCount + fullscreenExitCount + pageReloadCount > 3
        ? "REVIEW" : "OK",
    user_agent: navigator.userAgent,
    screen_resolution: `${screen.width}x${screen.height}`
  };

  fetch(SUBMIT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  }).finally(() => {
    document.body.innerHTML = `
      <div class="h-screen flex items-center justify-center text-xl font-bold">
        Exam submitted successfully.
      </div>`;
  });
}

/* ================= UTILS ================= */
function shuffle(arr) {
  return [...arr].sort(() => Math.random() - 0.5);
}
</script>
</body>
</html>